<!doctype html>
<html>
  
  <head>
    <title>Meetup Door Prize</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta content="text/html; charset=UTF-8" http-equiv="Content-Type">
    <link href="//netdna.bootstrapcdn.com/twitter-bootstrap/2.3.1/css/bootstrap-combined.min.css" rel="stylesheet">
    <link href="//netdna.bootstrapcdn.com/bootswatch/2.3.1/slate/bootstrap.min.css" rel="stylesheet">
    <link href="content/Site.css" rel="stylesheet" />
    <link href="//netdna.bootstrapcdn.com/twitter-bootstrap/2.3.1/css/bootstrap-responsive.min.css" rel="stylesheet">
  </head>
  
  <body>
    <div class="navbar navbar-fixed-top">
      <div class="navbar-inner">
          <div class="container">
              <!-- .btn-navbar is used as the toggle for collapsed navbar content -->
              <a class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse">
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
              </a>
              <a class="brand" href="#">Meetup Door Prize</a>
              <!-- Everything you want hidden at 940px or less, place within here -->
              <div class="nav-collapse collapse">
                  <ul class="nav  pull-right">
                      <li id="login">
                          <a class="connect" href="#">Connect with Meetup</a>
                      </li>
                      <li id="member"> 
                      </li>
                  </ul>
              </div>
          </div>
      </div>
    </div>
    <div class="container-fluid">
        <div class="page-header hidden-phone">
            <div class="container" id="header-logo">
                <img src="images/meetup-door-prize-logo.gif"> 
            </div>
            <div class="container">
                <br>
                <p class="lead" id="header-text">Do you have a Meetup.com group that gives out door prizes?
                    <br> Are you tired of handing out raffle tickets, throwing darts at the attendance
                    sheet, or arm wrestling for your door prizes?
                    <br> This is the better way to pick the winners.</p>
            </div>
        </div>
        <div id="loggedout">
            <div class="container">
                <div class="hero-unit">
                    <p>Get started:  <a href="#" class="connect btn btn-link btn-mini">Connect With Meetup</a></p>
                </div>
            </div>
        </div>
        <div id="loggedin" class="hidden">
            <h2 id="meeting-title">Some Meeting Title For Your Meetup
                <a href="#choose-meeting" class="btn btn-link btn-mini" data-toggle="modal">Change<br></a> 
            </h2>
            <div class="container">
                <div class="hero-unit">
                    <h2 id="winnername">Winner Name</h2>
                    <p id="winnerlocation">City, State</p>
                    <p>
                        <img src="//app.divshot.com/img/placeholder-100x100.gif" id="winnerphoto" class="img-polaroid"> 
                    </p>
                    <a class="btn" id="select-winner">Select Another</a> 
                </div>
            </div>
            <div class="container">
                <hr>
                <p>
                    <span>© <a href="http://www.justinsaraceno.com">Justin Saraceno</a> 2013</span> 
                </p>
            </div>
        </div>
    </div>
    <!-- choose meeting modal -->
      <div id="choose-meeting" class="modal hide fade" tabindex="-1" role="dialog"
           aria-labelledby="myModalLabel" aria-hidden="true" style="display: none;">
          <div class="modal-header">
              <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
              <h3 id="myModalLabel">Select a Meetup</h3>
          </div>
          <div class="modal-body">
              <ul id="events"></ul>
          </div>
          <div class="modal-footer">
              <button class="btn" data-dismiss="modal" aria-hidden="true">Cancel</button>
          </div>
      </div>
      
      <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
      <script src="//netdna.bootstrapcdn.com/twitter-bootstrap/2.3.1/js/bootstrap.min.js"></script>
      <script src="scripts/private.keys.js" type="text/javascript"></script>
      <script src="scripts/mu.api.js" type="text/javascript"></script>
      <script type="text/javascript">
          // initialize api
          api = mu.Api({
              clientId: "jd6cpjbd8v063nkgn52dpst4g1"
              , onMember: function (member, token) {
                  $(".connect").hide(); $("#disconnect").show();
                  $("#loggedout").hide(); $("#loggedin").removeClass("hidden");
                  $.getJSON("https://api.meetup.com/2/events?access_token=" + token +
                      "&member_id=self&page=10&callback=?", function (evts) {
                          var el = $("#events"), buff = [];
                          $.map(evts.results, function (e) {
                              buff.push('<li class="eventid" data-value=' + e.id + ' data-dismiss="modal">' + e.name.link('#') + '</li>');
                          });
                          el.append(buff.join(''));
                          console.log('adding events');
                          addEventClick();
                      });
                  $("#member").html("<a href='#' id='disconnect'>Logout " + member.name + "</a>");
                  $("#choose-meeting").modal('show');
              }
          });

          (function ($) {
              $(function () {
                  $(".connect").on('click', function (e) {
                      e.preventDefault();
                      console.log('in login');
                      api.login();
                      return false;
                  });
                  
                  $("#member").on('click', '#disconnect', function (e) {
                      e.preventDefault();
                      console.log('in logout');
                      api.logout(function () {
                          $("#disconnect").hide(); $("#connect").show();
                          $("loggedin").hide();
                          window.location.reload();
                      });
                      return false;
                  });
              });
          })(jQuery);
      </script>
      <script type="text/javascript">
          function addEventClick() {
              console.log('adding click event');
              $("#events li").on('click', (function(e) {
                  e.preventDefault();
                  console.log("In click event");
                  var eventId = $(this).attr("data-value");
                  meetupService.getEvent($(this).attr("data-value"), function(data) {
                      $('#meeting-title')[0].firstChild.data = data.name;
                  });
                  
                  // get 'yes' rsvp's
                  meetupService.getRsvps(eventId, 'yes', function (data) {
                      if (data.results.length > 0) {
                          var i = 0;
                          var attendees = new Array();
                          for (i = 0; i < data.results.length; i++) {
                              attendees[i] = [data.results[i].member.member_id];
                              console.log("attendees array filled");
                          }
                          localStorage["attendees"] = JSON.stringify(attendees);
                          console.log("Initial attendee count: " + JSON.parse(localStorage["attendees"]).length);
                          meetupService.getWinnerDetails(chooseWinnerId(), function (winner) {
                              console.log("Winner chosen as: " + winner.name);
                          });
                      }
                  });
              }));
          }

          // ajax calls
          var meetupService = new function () {
              var serviceBase = 'https://api.meetup.com',
                  getEvent = function (eventId, callback) {
                      $.getJSON(serviceBase + '/2/event/' + eventId + '?callback=?', { key: apiKey }, function (data) {
                          callback(data);
                      });
                  },
                  getWinnerDetails = function (userId, callback) {
                      $.getJSON(serviceBase + '/2/member/' + userId + '?callback=?', { key: apiKey }, function (data) {
                          callback(data);
                      });
                  },
                  getRsvps = function (eventId, rsvp, callback) {
                      $.getJSON(serviceBase + '/2/rsvps?callback=?', { key: apiKey, rsvp: 'yes', event_id: eventId }, function (data) {
                          callback(data);
                      });
                  };

              return {
                  getEvent: getEvent,
                  getRsvps: getRsvps,
                  getWinnerDetails: getWinnerDetails
              };
          }();
          
          // choose winner logic
          function chooseWinnerId() {
              var attendees = JSON.parse(localStorage["attendees"]);
              var randomRsvp = Math.floor(Math.random() * attendees.length);
              var userId = attendees[randomRsvp];
              console.log('winner user id=' + userId);
              getWinnerDetails(userId);
              attendees = $.grep(attendees, function (value) {
                  return value != userId;
              });
              console.log("attendees length=" + attendees.length);
              localStorage["attendees"] = JSON.stringify(attendees);
              console.log("Attendee count updated to: " + JSON.parse(localStorage["attendees"]).length);
              return userId;
          }
          
          // get winner details
          function getWinnerDetails(userId) {
              console.log("getting winner details...");
              meetupService.getWinnerDetails(userId, function(data) {
                  if (data != null) {
                      console.log("Winner chosen..");
                      //$('#winnerInfo').show();
                      //// remove green alert background
                      //$('div').removeClass('alert-info');

                      //var winnerHTML = '<div class="span2 thumbnail alert alert-info" style="height:150px; text-align: center; position: relative;">';
                      if (data.photo != null) {
                          //winnerHTML += '<div ><img src="' + data.photo.thumb_link + '" /></div>';
                          console.log("Photo found at: " + data.photo.photo_link);
                          $("#winnerphoto").attr('src', data.photo.photo_link);
                      } else {
                          //winnerHTML += '<div><img src="./images/nophoto.gif" /></div>';
                          console.log("No photo found..");
                          $("#winnerphoto").attr('src', './images/nophoto.gif');
                      }
                      $('#winnername').text(data.name);
                      $('#winnerlocation').text(data.city + ', ' + data.state);
                      //winnerHTML += '<div><strong>' + data.name + '</strong></div>';
                      //winnerHTML += '<div>' + data.city + ', ' + data.state + '</div>';
                      //winnerHTML += '<span class="badge" style="position: absolute; bottom: 0;">' + (attendeeCount - attendees.length) + '</span>';
                      //winnerHTML += '</div>';
                      //$('#winnerInfo2').prepend(winnerHTML);
                  }
              });
          }
      </script>
  </body>

</html>